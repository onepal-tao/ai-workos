<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIå¹¿å‘Šå…¬å¸ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg: #f5f5f7;
            --sidebar: #ffffff;
            --card: #ffffff;
            --text: #1d1d1f;
            --text2: #86868b;
            --accent: #0071e3;
            --success: #34c759;
            --warning: #ff9500;
            --danger: #ff3b30;
            --purple: #af52de;
            --pink: #ff2d55;
            --border: rgba(0,0,0,0.08);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }
        
        /* ç™»å½• */
        .login-screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }
        
        .login-screen h1 { font-size: 28px; font-weight: 600; }
        .login-screen input {
            width: 280px;
            padding: 16px 20px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--card);
            font-size: 16px;
        }
        .login-screen .btn {
            width: 280px;
            padding: 16px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* ä¸»å¸ƒå±€ */
        .app-layout { display: none; min-height: 100vh; }
        .app-layout.active { display: flex; }
        
        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 180px;
            background: var(--sidebar);
            padding: 20px 12px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            border-right: 1px solid var(--border);
        }
        .sidebar-brand {
            font-size: 18px;
            font-weight: 700;
            padding: 0 12px 20px;
            margin-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }
        .nav-item {
            padding: 10px 14px;
            border-radius: 8px;
            color: var(--text2);
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.15s;
        }
        .nav-item:hover { background: var(--bg); color: var(--text); }
        .nav-item.active { background: var(--accent); color: white; }
        .nav-item.admin-only { margin-top: auto; border-top: 1px solid var(--border); padding-top: 12px; }
        
        /* ä¸»å†…å®¹ */
        .main-content { flex: 1; padding: 20px 24px; overflow-y: auto; }
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .header-bar h2 { font-size: 22px; font-weight: 600; }
        .user-info { display: flex; align-items: center; gap: 16px; }
        .points-badge {
            padding: 6px 14px;
            background: linear-gradient(135deg, var(--warning), #ff6b35);
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            color: white;
        }
        .user-info button {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
        }
        
        /* é¢æ¿ */
        .panel { display: none; }
        .panel.active { display: block; }
        
        /* æ‰“å¡ç«™ */
        .checkin-layout {
            display: grid;
            grid-template-columns: 1fr 280px;
            gap: 16px;
            align-items: start;
        }
        
        /* å·¦ä¾§åŒºåŸŸå’Œæœˆå†å¯¹é½ */
        .checkin-left {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        /* æœˆå† */
        .calendar-section {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border);
        }
        .cal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .cal-header h3 { font-size: 18px; font-weight: 600; }
        .cal-nav { display: flex; gap: 8px; }
        .cal-nav button {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--bg);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }
        .weekday {
            text-align: center;
            font-size: 12px;
            color: var(--text2);
            padding: 8px 0;
            font-weight: 500;
        }
        .day {
            width: 100%;
            height: 95px;
            min-height: 95px;
            max-height: 95px;
            border-radius: 8px;
            padding: 5px;
            background: #fafafa;
            cursor: pointer;
            position: relative;
            transition: all 0.15s;
            border: 1px solid transparent;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        /* æœªæ¥çš„å‘¨å…­æ—¥ - æµ…ç°ä¼‘æ¯æ„Ÿ */
        .day.weekend { background: #f0f0f2; }
        /* æœªæ¥çš„èŠ‚å‡æ—¥ - æµ…ç°+çº¢è¾¹ */
        .day.holiday { background: #f0f0f2; border: 1px solid rgba(255, 59, 48, 0.25); }
        /* è¿‡å»çš„æ—¥å­ - å¼±åŒ–å­˜åœ¨æ„Ÿï¼Œææ·¡çš„å½©è‰² */
        .day.past { 
            background: #f5f5f7; 
            opacity: 0.6;
        }
        .day.past .day-num { color: #999; }
        /* è¿‡å»çš„å‘¨å…­æ—¥ - æ·¡è“ç° */
        .day.past.weekend { background: #e8eaed; }
        /* è¿‡å»çš„èŠ‚å‡æ—¥ - æ·¡æš–ç° */
        .day.past.holiday { background: #f0ebe8; border-color: rgba(255, 59, 48, 0.15); }
        /* ä»Šå¤© - è“è‰²è¾¹æ¡†é«˜äº® */
        .day.today { 
            background: #fafafa; 
            border: 2px solid var(--accent); 
            box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.08);
        }
        .day.today.weekend { background: #f0f0f2; }
        .day.today.holiday { background: #f0f0f2; }
        .day:hover { border-color: var(--accent); background: #fff; }
        .day-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 3px;
            flex-shrink: 0;
        }
        .day-num { font-size: 11px; font-weight: 600; }
        .day-checkin { font-size: 10px; color: var(--success); font-weight: 600; }
        .day.today .day-checkin { color: rgba(255,255,255,0.9); }
        .day-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
            overflow: hidden;
        }
        .day-item {
            display: flex;
            align-items: center;
            gap: 3px;
            font-size: 10px;
            padding: 2px 4px;
            background: rgba(0, 113, 227, 0.1);
            border-radius: 3px;
            white-space: nowrap;
            overflow: hidden;
            flex-shrink: 0;
        }
        .day-item-dot { width: 3px; height: 3px; background: var(--accent); border-radius: 50%; flex-shrink: 0; }
        .day-item-text { flex: 1; overflow: hidden; text-overflow: ellipsis; max-width: 55px; }
        .day-item-check {
            width: 10px; height: 10px;
            border: 1px solid var(--accent);
            border-radius: 2px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 7px;
            color: white;
            cursor: pointer;
        }
        .day-item-check.done { background: var(--accent); }
        .day.today .day-item { background: rgba(0, 113, 227, 0.1); }
        .day.today .day-item-dot { background: var(--accent); }
        .day.today .day-item-check { border-color: var(--accent); }
        .day-more { font-size: 10px; color: var(--text2); text-align: center; padding: 3px; flex-shrink: 0; }
        
        /* å³ä¾§å¡ç‰‡ */
        .right-section { display: flex; flex-direction: column; gap: 12px; }
        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 14px;
            border: 1px solid var(--border);
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .card-title { font-size: 14px; font-weight: 600; }
        .card-btn {
            padding: 4px 10px;
            background: var(--bg);
            border: none;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            color: var(--text2);
        }
        .card-btn:hover { background: var(--accent); color: white; }
        
        /* æ‰“å¡æŒ‰é’® */
        .checkin-btn {
            width: 100%;
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--success), #16a34a);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            height: 40px;
            line-height: 20px;
        }
        .checkin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(52,199,94,0.3);
        }
        .checkin-btn:active {
            transform: translateY(0);
        }
        .checkin-done {
            text-align: center;
            color: var(--success);
            font-size: 15px;
            font-weight: 600;
            height: 40px;
            line-height: 40px;
        }
        
        /* ä»»åŠ¡åˆ—è¡¨ */
        .task-list { display: flex; flex-direction: column; gap: 8px; }
        .task-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background: var(--bg);
            border-radius: 8px;
            min-height: 44px;
            height: 44px;
        }
        .task-text { font-size: 13px; flex: 1; }
        .task-status {
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 11px;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            min-width: 60px;
            text-align: center;
        }
        .task-status.todo { background: var(--bg); color: var(--text2); border: 1px solid var(--border); }
        .task-status.doing { background: rgba(0,113,227,0.15); color: var(--accent); }
        .task-status.done { background: rgba(52,199,89,0.15); color: var(--success); }
        
        /* æŒ‘æˆ˜ä»»åŠ¡ */
        .challenge-list { display: flex; flex-direction: column; gap: 10px; }
        .challenge-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg);
            border-radius: 8px;
        }
        .challenge-info { flex: 1; }
        .challenge-name { font-size: 13px; font-weight: 600; margin-bottom: 2px; }
        .challenge-meta { font-size: 11px; color: var(--text2); }
        .challenge-points {
            padding: 4px 10px;
            background: linear-gradient(135deg, var(--warning), #ff6b35);
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }
        .challenge-status {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
        }
        .challenge-status.pending { background: #fff3e0; color: var(--warning); }
        .challenge-status.doing { background: #e3f2fd; color: var(--accent); }
        .challenge-status.done { background: #e8f5e9; color: var(--success); }
        
        /* è°ƒä¼‘è®°å½• */
        .leave-record {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: var(--bg);
            border-radius: 8px;
            margin-top: 8px;
        }
        .leave-days {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent);
        }
        .leave-label { font-size: 12px; color: var(--text2); }
        
        /* è¡¥å¡é“¾æ¥ */
        .makeup-link { text-align: center; padding: 16px; }
        .makeup-link a { color: var(--text2); font-size: 13px; text-decoration: none; }
        
        /* çµæ„Ÿå¢™ */
        .ideas-layout { 
            display: flex; 
            gap: 16px; 
            align-items: flex-start;
        }
        .idea-input-card {
            width: 180px;
            min-width: 180px;
            height: 220px;
            min-height: 220px;
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: sticky;
            top: 0;
        }
        .idea-input-card textarea {
            width: 100%;
            flex: 1;
            min-height: 140px;
            padding: 10px;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 8px;
            font-size: 13px;
            resize: none;
            font-family: inherit;
            background: rgba(255,255,255,0.8);
        }
        .idea-input-card button {
            padding: 10px;
            background: var(--warning);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }
        .ideas-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        .ideas-tab {
            padding: 8px 16px;
            background: var(--bg);
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            border: none;
        }
        .ideas-tab.active { background: var(--accent); color: white; }
        .ideas-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            flex: 1;
        }
        .idea-note {
            width: 180px;
            min-height: 220px;
            height: 220px;
            border-radius: 12px;
            padding: 14px;
            position: relative;
            transform: rotate(-1deg);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .idea-note[data-color="0"] { transform: rotate(-1deg); background: linear-gradient(135deg, #fef3c7, #fde68a); }
        .idea-note[data-color="1"] { transform: rotate(1deg); background: linear-gradient(135deg, #dbeafe, #bfdbfe); }
        .idea-note[data-color="2"] { transform: rotate(0.5deg); background: linear-gradient(135deg, #fce7f3, #fbcfe8); }
        .idea-note[data-color="3"] { transform: rotate(-0.5deg); background: linear-gradient(135deg, #d1fae5, #a7f3d0); }
        .idea-note[data-color="4"] { transform: rotate(1.5deg); background: linear-gradient(135deg, #ede9fe, #ddd6fe); }
        .idea-note[data-color="5"] { transform: rotate(-1.5deg); background: linear-gradient(135deg, #fee2e2, #fecaca); }
        .idea-note.starred { order: -1; box-shadow: 0 4px 16px rgba(255,193,7,0.4); }
        .idea-author {
            font-size: 11px;
            opacity: 0.7;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
        }
        .idea-time { font-size: 10px; }
        .idea-content { font-size: 13px; line-height: 1.5; }
        .idea-actions {
            position: absolute;
            bottom: 10px;
            right: 10px;
            display: flex;
            gap: 6px;
        }
        .idea-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .idea-btn.star { background: rgba(255,255,255,0.8); }
        .idea-btn.star.active { background: #ffc107; }
        .idea-btn.delete { background: rgba(255,255,255,0.8); color: var(--danger); }
        
        /* é€‰é¢˜æ  */
        .topic-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }
        .topic-card {
            background: var(--card);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: transform 0.2s;
        }
        .topic-card:hover { transform: translateY(-4px); }
        .topic-image {
            width: 100%;
            height: 200px;
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
        }
        .topic-content { padding: 16px; }
        .topic-title { font-size: 16px; font-weight: 600; margin-bottom: 8px; }
        .topic-desc {
            font-size: 13px;
            color: var(--text2);
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .topic-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }
        .topic-author { font-size: 12px; color: var(--text2); }
        .topic-points { font-size: 12px; color: var(--success); font-weight: 600; }
        
        /* ç§¯åˆ†ä¸­å¿ƒ */
        .achievements-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }
        .achievement-section {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border);
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .section-title { font-size: 18px; font-weight: 600; }
        .section-points { font-size: 14px; color: var(--accent); font-weight: 600; }
        
        /* Steamé£æ ¼è¿›åº¦æ¡ */
        .steam-achievement {
            margin-bottom: 20px;
            padding: 16px;
            background: var(--bg);
            border-radius: 12px;
        }
        .steam-achievement-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .steam-achievement-name { font-size: 15px; font-weight: 600; }
        .steam-achievement-reward { font-size: 13px; color: var(--warning); font-weight: 600; }
        .steam-progress-container {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        .steam-progress-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease, background 0.3s;
        }
        .steam-progress-bar.gray { background: linear-gradient(90deg, #9e9e9e, #bdbdbd); }
        .steam-progress-bar.yellow { background: linear-gradient(90deg, #ffc107, #ff9800); }
        .steam-progress-bar.green { background: linear-gradient(90deg, #4caf50, #8bc34a); }
        .steam-progress-text {
            font-size: 12px;
            color: var(--text2);
            margin-top: 6px;
            text-align: right;
        }
        
        /* å…‘æ¢ä¸­å¿ƒ */
        .shop-section {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border);
        }
        .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }
        .shop-item {
            background: var(--bg);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .shop-item:hover { border-color: var(--accent); }
        .shop-item-icon { font-size: 40px; margin-bottom: 12px; }
        .shop-item-name { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
        .shop-item-price { font-size: 13px; color: var(--warning); margin-bottom: 12px; }
        .shop-item-btn {
            width: 100%;
            padding: 10px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
        }
        .shop-item-btn:disabled { background: var(--bg); color: var(--text2); cursor: not-allowed; }
        
        /* å¼¹çª— */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .modal-overlay.active { display: flex; }
        .modal-box {
            background: var(--card);
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }
        .modal-box h3 { font-size: 18px; margin-bottom: 20px; }
        .modal-row {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }
        .modal-row input {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
        }
        .modal-row input[type="number"] {
            -moz-appearance: textfield;
            appearance: textfield;
            flex: 0 0 80px;
        }
        .modal-row input[type="number"]::-webkit-inner-spin-button,
        .modal-row input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .plan-section { margin-bottom: 16px; }
        .plan-label { font-size: 13px; font-weight: 600; margin-bottom: 6px; }
        .plan-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            resize: vertical;
            min-height: 50px;
            font-family: inherit;
        }
        .modal-btns {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .modal-btns button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
        }
        .modal-btns .cancel { background: var(--bg); }
        .modal-btns .submit { background: var(--accent); color: white; }
        
        /* é€‰é¢˜å¼¹çª— - å°çº¢ä¹¦é£æ ¼ */
        .topic-modal-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .topic-image-upload {
            aspect-ratio: 3/4;
            background: var(--bg);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            cursor: pointer;
            border: 2px dashed var(--border);
        }
        .topic-image-upload:hover { border-color: var(--accent); }
        .topic-form { display: flex; flex-direction: column; gap: 12px; }
        .topic-form input, .topic-form textarea {
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
        }
        .topic-form textarea { flex: 1; min-height: 150px; resize: none; }
        
        /* åŠ¨ç”» */
        @keyframes emojiPop {
            0% { transform: translate(-50%, -50%) scale(0) rotate(0deg); opacity: 1; }
            50% { transform: translate(calc(-50% + var(--tx) * 0.5), calc(-50% + var(--ty) * 0.5)) scale(1.2) rotate(180deg); opacity: 1; }
            100% { transform: translate(calc(-50% + var(--tx)), calc(-50% + var(--ty))) scale(0) rotate(360deg); opacity: 0; }
        }
        @keyframes particlePop {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(calc(-50% + var(--tx)), calc(-50% + var(--ty))) scale(0); opacity: 0; }
        }
        
        /* ä»Šæ—¥æ‰“å¡å¡ç‰‡å›ºå®šé«˜åº¦ */
        .leave-tabs { display: flex; gap: 8px; margin-bottom: 16px; }
        .leave-tab { flex: 1; padding: 10px; background: var(--bg); border: none; border-radius: 8px; font-size: 13px; cursor: pointer; }
        .leave-tab.active { background: var(--accent); color: white; }
        .leave-history { max-height: 200px; overflow-y: auto; }
        .leave-history-item { display: flex; justify-content: space-between; padding: 10px; background: var(--bg); border-radius: 8px; margin-bottom: 8px; font-size: 13px; }

        /* å¼¹çª—äº‹é¡¹åˆ—è¡¨ */
        .modal-items {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 16px;
        }
        .modal-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            background: var(--bg);
            border-radius: 10px;
            margin-bottom: 10px;
            font-size: 14px;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        .modal-item:hover {
            background: #f5f5f7;
            border-color: var(--border);
        }
        .modal-item span {
            flex: 1;
            word-break: break-word;
            line-height: 1.5;
            padding-right: 16px;
            color: var(--text);
        }
        .modal-item button {
            padding: 6px 14px;
            background: rgba(255, 59, 48, 0.08);
            color: var(--danger);
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            font-weight: 500;
        }
        .modal-item button:hover {
            background: var(--danger);
            color: white;
        }

        @keyframes textPop {
            0% { opacity: 0; transform: translateX(-50%) translateY(10px) scale(0.8); }
            20% { opacity: 1; transform: translateX(-50%) translateY(0) scale(1.1); }
            80% { opacity: 1; transform: translateX(-50%) translateY(-20px) scale(1); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-40px) scale(0.9); }
        }
        @keyframes pointsPop {
            0% { opacity: 0; transform: translateX(-50%) scale(0.5); }
            30% { opacity: 1; transform: translateX(-50%) scale(1.3); }
            60% { opacity: 1; transform: translateX(-50%) scale(1.1) translateY(-30px); }
            100% { opacity: 0; transform: translateX(-50%) scale(1) translateY(-60px); }
        }
        
        /* å“åº”å¼ */
        @media (max-width: 1024px) {
            .checkin-layout { grid-template-columns: 1fr; }
            .achievements-layout { grid-template-columns: 1fr; }
            .ideas-layout { flex-direction: column; }
            .idea-input-card { width: 100%; }
        }
        @media (max-width: 768px) {
            .sidebar { width: 60px; padding: 16px 8px; }
            .nav-item span { display: none; }
        }
    </style>
</head>
<body>
    <!-- ç™»å½• -->
    <div class="login-screen" id="login">
        <h1>AIå¹¿å‘Šå…¬å¸ç®¡ç†ç³»ç»Ÿ</h1>
        <input type="text" id="loginName" placeholder="è¯·è¾“å…¥å§“å">
        <button class="btn" onclick="doLogin()">è¿›å…¥ç³»ç»Ÿ</button>
    </div>

    <!-- ä¸»åº”ç”¨ -->
    <div class="app-layout" id="app">
        <nav class="sidebar">
            <div class="sidebar-brand">ğŸš€ WorkOS</div>
            <div class="nav-item active" onclick="switchPanel('checkin')" data-panel="checkin">
                ğŸ“ <span>æ‰“å¡ç«™</span>
            </div>
            <div class="nav-item" onclick="switchPanel('ideas')" data-panel="ideas">
                ğŸ’¡ <span>çµæ„Ÿå¢™</span>
            </div>
            <div class="nav-item" onclick="switchPanel('topics')" data-panel="topics">
                ğŸ“ <span>é€‰é¢˜æ </span>
            </div>
            <div class="nav-item" onclick="switchPanel('points')" data-panel="points">
                ğŸ† <span>ç§¯åˆ†ä¸­å¿ƒ</span>
            </div>
            <div class="nav-item admin-only" onclick="switchPanel('admin')" data-panel="admin" id="adminNav" style="display:none;">
                âš™ï¸ <span>ç®¡ç†</span>
            </div>
        </nav>

        <main class="main-content">
            <!-- å¤´éƒ¨ -->
            <div class="header-bar">
                <h2 id="pageTitle">æ‰“å¡ç«™</h2>
                <div class="user-info">
                    <span id="userNameDisplay"></span>
                    <span class="points-badge" id="userPoints">ğŸ’° 0</span>
                    <button onclick="logout()">é€€å‡º</button>
                </div>
            </div>

            <!-- æ‰“å¡ç«™ -->
            <div class="panel active" id="panel-checkin">
                <div class="checkin-layout">
                    <!-- å·¦ä¾§æœˆå† -->
                    <div class="calendar-section">
                        <div class="cal-header">
                            <h3 id="calTitle">2026å¹´2æœˆ</h3>
                            <div class="cal-nav">
                                <button onclick="changeMonth(-1)">â€¹</button>
                                <button onclick="changeMonth(1)">â€º</button>
                            </div>
                        </div>
                        <div class="calendar-grid" id="calGrid"></div>
                    </div>
                    
                    <!-- å³ä¾§ -->
                    <div class="right-section">
                        <!-- ç¬¬ä¸€è¡Œï¼šä»Šæ—¥æ‰“å¡ + è°ƒä¼‘å¤©æ•° -->
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                            <!-- ä»Šæ—¥æ‰“å¡ -->
                            <div class="card" style="display:flex;flex-direction:column;">
                                <div class="card-title" style="margin-bottom:8px;height:20px;line-height:20px;">ä»Šæ—¥æ‰“å¡</div>
                                <div id="checkinBox" style="flex:1;display:flex;align-items:center;justify-content:center;"></div>
                            </div>
                            
                            <!-- è°ƒä¼‘å¤©æ•° -->
                            <div class="card" style="cursor:pointer;display:flex;flex-direction:column;" onclick="openLeaveModal()">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;height:20px;">
                                    <div class="card-title">è°ƒä¼‘å¤©æ•°</div>
                                    <button class="card-btn" style="padding:2px 8px;font-size:11px;" onclick="event.stopPropagation();openLeaveModal()">ç®¡ç†</button>
                                </div>
                                <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;">
                                    <div style="font-size:28px;font-weight:700;color:var(--accent);line-height:1;"><span id="leaveDays">0</span></div>
                                    <div style="font-size:11px;color:var(--text2);margin-top:2px;">å¤©</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æœ¬å‘¨è®¡åˆ’ -->
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">æœ¬å‘¨è®¡åˆ’</div>
                                <button class="card-btn" onclick="openWeekPlanModal()">è®¾ç½®</button>
                            </div>
                            <div class="task-list" id="taskList"></div>
                        </div>
                        
                        <!-- åˆ›æ–°ä»»åŠ¡ -->
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">åˆ›æ–°ä»»åŠ¡</div>
                                <button class="card-btn" onclick="openChallengeModal()">ç”³æŠ¥</button>
                            </div>
                            <div class="challenge-list" id="challengeList"></div>
                        </div>
                    </div>
                </div>
                
                <div class="makeup-link">
                    <a href="#" onclick="openMakeupModal();return false;">ç”³è¯·è¡¥å¡</a>
                </div>
            </div>

            <!-- çµæ„Ÿå¢™ -->
            <div class="panel" id="panel-ideas">
                <div class="ideas-tabs">
                    <button class="ideas-tab active" onclick="switchIdeaTab('private')">ç§äºº</button>
                    <button class="ideas-tab" onclick="switchIdeaTab('company')">å…¬å¸</button>
                </div>
                <div class="ideas-layout">
                    <div class="idea-input-card">
                        <textarea id="ideaInput" placeholder="è®°å½•çµæ„Ÿ..."></textarea>
                        <button onclick="addIdea()">ğŸ’¡ è´´ä¸Šä¾¿åˆ©è´´</button>
                    </div>
                    
                    <div class="ideas-grid" id="ideasGrid"></div>
                </div>
            </div>

            <!-- é€‰é¢˜æ  -->
            <div class="panel" id="panel-topics">
                <div class="card-header" style="margin-bottom:20px;">
                    <div class="card-title">é€‰é¢˜åº“</div>
                    <button class="card-btn" onclick="openTopicModal()">+ å¢åŠ é€‰é¢˜</button>
                </div>
                <div class="topic-list" id="topicList"></div>
            </div>

            <!-- ç§¯åˆ†ä¸­å¿ƒ -->
            <div class="panel" id="panel-points">
                <div class="achievements-layout">
                    <!-- å·¦ä¾§ï¼šæ¯æœˆæˆå°± -->
                    <div class="achievement-section">
                        <div class="section-header">
                            <div class="section-title">ğŸ“… æ¯æœˆæˆå°±</div>
                            <div class="section-points">æœ¬æœˆå¯è·: 100åˆ†</div>
                        </div>
                        
                        <div class="steam-achievement">
                            <div class="steam-achievement-header">
                                <div class="steam-achievement-name">ğŸƒ æœˆå…¨å‹¤</div>
                                <div class="steam-achievement-reward">+30åˆ†</div>
                            </div>
                            <div class="steam-progress-container">
                                <div class="steam-progress-bar gray" id="monthFullProgress" style="width:0%"></div>
                            </div>
                            <div class="steam-progress-text" id="monthFullText">0/22å¤©</div>
                        </div>
                        
                        <div class="steam-achievement">
                            <div class="steam-achievement-header">
                                <div class="steam-achievement-name">ğŸ“‹ ä¸‰æ¬¡å‘¨è®¡åˆ’å®Œæˆç‡100%</div>
                                <div class="steam-achievement-reward">+70åˆ†</div>
                            </div>
                            <div class="steam-progress-container">
                                <div class="steam-progress-bar gray" id="weekPlanProgress" style="width:0%"></div>
                            </div>
                            <div class="steam-progress-text" id="weekPlanText">0/3å‘¨</div>
                        </div>
                    </div>
                    
                    <!-- å³ä¾§ï¼šç»ˆèº«æˆå°± -->
                    <div class="achievement-section">
                        <div class="section-header">
                            <div class="section-title">ğŸ‘‘ ç»ˆèº«æˆå°±</div>
                        </div>
                        
                        <div class="steam-achievement">
                            <div class="steam-achievement-header">
                                <div class="steam-achievement-name">ğŸš€ åˆ›æ–°è¾¾äºº I</div>
                                <div class="steam-achievement-reward">+100åˆ†</div>
                            </div>
                            <div class="steam-progress-container">
                                <div class="steam-progress-bar gray" id="innovationProgress1" style="width:0%"></div>
                            </div>
                            <div class="steam-progress-text" id="innovationText1">0/10ä¸ªæŒ‘æˆ˜</div>
                        </div>
                        
                        <div class="steam-achievement">
                            <div class="steam-achievement-header">
                                <div class="steam-achievement-name">ğŸš€ åˆ›æ–°è¾¾äºº II</div>
                                <div class="steam-achievement-reward">+750åˆ†</div>
                            </div>
                            <div class="steam-progress-container">
                                <div class="steam-progress-bar gray" id="innovationProgress2" style="width:0%"></div>
                            </div>
                            <div class="steam-progress-text" id="innovationText2">0/50ä¸ªæŒ‘æˆ˜</div>
                        </div>
                        
                        <div class="steam-achievement">
                            <div class="steam-achievement-header">
                                <div class="steam-achievement-name">ğŸš€ åˆ›æ–°è¾¾äºº III</div>
                                <div class="steam-achievement-reward">+2000åˆ†</div>
                            </div>
                            <div class="steam-progress-container">
                                <div class="steam-progress-bar gray" id="innovationProgress3" style="width:0%"></div>
                            </div>
                            <div class="steam-progress-text" id="innovationText3">0/100ä¸ªæŒ‘æˆ˜</div>
                        </div>
                    </div>
                </div>
                
                <!-- å…‘æ¢ä¸­å¿ƒ -->
                <div class="shop-section">
                    <div class="section-title">ğŸ å…‘æ¢ä¸­å¿ƒ</div>
                    
                    <div class="shop-grid">
                        <div class="shop-item">
                            <div class="shop-item-icon">ğŸ–ï¸</div>
                            <div class="shop-item-name">è°ƒä¼‘å¤©æ•°+1</div>
                            <div class="shop-item-price">ğŸ’° 300ç§¯åˆ†</div>
                            <button class="shop-item-btn" onclick="exchangeItem('leave', 300)">å…‘æ¢</button>
                        </div>
                        
                        <div class="shop-item">
                            <div class="shop-item-icon">ğŸ</div>
                            <div class="shop-item-name">ç¥ç§˜è®¸æ„¿</div>
                            <div class="shop-item-price">ğŸ’° 600ç§¯åˆ†</div>
                            <button class="shop-item-btn" onclick="exchangeItem('wish', 600)">å…‘æ¢</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- å¼¹çª—ä»¬ -->
    <div class="modal-overlay" id="weekPlanModal">
        <div class="modal-box">
            <h3>è®¾ç½®æœ¬å‘¨è®¡åˆ’</h3>
            <div id="weekPlanTasks"></div>
            <div style="display:flex;gap:8px;margin-top:12px;">
                <input type="text" id="weekPlanInput" placeholder="æ·»åŠ ä»»åŠ¡..." style="flex:1;padding:10px;border:1px solid var(--border);border-radius:8px;">
                <button onclick="addWeekPlanTask()" style="padding:10px 16px;background:var(--accent);color:white;border:none;border-radius:8px;cursor:pointer;">æ·»åŠ </button>
            </div>
            <div class="modal-btns">
                <button class="cancel" onclick="closeWeekPlanModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="challengeModal">
        <div class="modal-box">
            <h3>åˆ›æ–°ä»»åŠ¡ç”³æŠ¥</h3>
            
            <div class="modal-row">
                <input type="text" id="chName" placeholder="é¡¹ç›®åç§°">
                <input type="number" id="chPoints" placeholder="ç§¯åˆ†" style="width:80px;">
            </div>
            
            <div class="modal-row">
                <select id="chDays" style="flex:1;padding:12px;border:1px solid var(--border);border-radius:10px;font-size:14px;">
                    <option value="">é€‰æ‹©å®Œæˆå¤©æ•°</option>
                    <option value="1">1å¤©</option>
                    <option value="3">3å¤©</option>
                    <option value="7">7å¤©</option>
                    <option value="14">14å¤©</option>
                </select>
            </div>
            
            <div class="plan-section"><div class="plan-label">1. æˆ‘è¦åšä»€ä¹ˆï¼š</div><textarea class="plan-input" id="chQ1"></textarea></div>
            <div class="plan-section"><div class="plan-label">2. è§£å†³ä»€ä¹ˆé—®é¢˜ï¼š</div><textarea class="plan-input" id="chQ2"></textarea></div>
            <div class="plan-section"><div class="plan-label">3. æ€ä¹ˆå®Œæˆï¼š</div><textarea class="plan-input" id="chQ3"></textarea></div>
            <div class="plan-section"><div class="plan-label">4. éœ€è¦ä»€ä¹ˆå¸®åŠ©ï¼š</div><textarea class="plan-input" id="chQ4"></textarea></div>
            <div class="plan-section"><div class="plan-label">5. æ€ä¹ˆç®—å®Œæˆï¼š</div><textarea class="plan-input" id="chQ5"></textarea></div>
            <div class="plan-section"><div class="plan-label">6. å¤‡æ³¨ï¼š</div><textarea class="plan-input" id="chQ6"></textarea></div>
            
            <div class="modal-btns">
                <button class="cancel" onclick="closeChallengeModal()">å–æ¶ˆ</button>
                <button class="submit" onclick="submitChallenge()">æäº¤ç”³æŠ¥</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="topicModal">
        <div class="modal-box" style="max-width:700px;">
            <h3>å¢åŠ é€‰é¢˜</h3>
            
            <div class="topic-modal-content">
                <div class="topic-image-upload" onclick="document.getElementById('topicImage').click()">
                    <div style="font-size:48px;">ğŸ“·</div>
                    <div style="font-size:14px;color:var(--text2);">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</div>
                    <input type="file" id="topicImage" accept="image/*" style="display:none;" onchange="previewTopicImage(this)">
                </div>
                
                <div class="topic-form">
                    <input type="text" id="topicTitle" placeholder="æ ‡é¢˜">
                    <textarea id="topicDesc" placeholder="å†…å®¹æè¿°..."></textarea>
                    <div style="font-size:12px;color:var(--text2);padding:8px;background:var(--bg);border-radius:8px;">
                        ğŸ’¡ å¢åŠ é€‰é¢˜ +5ç§¯åˆ† | å‘å¸ƒæˆåŠŸ +20ç§¯åˆ†
                    </div>
                </div>
            </div>
            
            <div class="modal-btns">
                <button class="cancel" onclick="closeTopicModal()">å–æ¶ˆ</button>
                <button class="submit" onclick="submitTopic()">æäº¤ (+5ç§¯åˆ†)</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="dayModal">
        <div class="modal-box">
            <h3 id="dayModalTitle">ç¼–è¾‘äº‹é¡¹</h3>
            <div class="modal-items" id="dayItems"></div>
            <input type="text" id="newDayItem" placeholder="æ·»åŠ æ–°äº‹é¡¹" style="width:100%;padding:12px;border:1px solid var(--border);border-radius:10px;font-size:14px;">
            
            <div class="modal-btns">
                <button class="cancel" onclick="closeDayModal()">å…³é—­</button>
                <button class="submit" onclick="addDayItem()">æ·»åŠ </button>
            </div>
        </div>
    </div>

    <!-- è¡¥å¡å¼¹çª— -->
    <div class="modal-overlay" id="makeupModal">
        <div class="modal-box">
            <h3>ç”³è¯·è¡¥å¡</h3>
            <div class="modal-row">
                <input type="date" id="makeupDate" placeholder="è¡¥å¡æ—¥æœŸ">
            </div>
            <div class="modal-row">
                <input type="text" id="makeupReason" placeholder="è¡¥å¡åŸå› ">
            </div>
            <div class="modal-btns">
                <button class="cancel" onclick="closeMakeupModal()">å–æ¶ˆ</button>
                <button class="submit" onclick="submitMakeup()">æäº¤ç”³è¯·</button>
            </div>
        </div>
    </div>

    <!-- è°ƒä¼‘å¼¹çª— -->
    <div class="modal-overlay" id="leaveModal">
        <div class="modal-box">
            <h3>è°ƒä¼‘ç®¡ç†</h3>
            
            <div style="display:flex;gap:8px;margin-bottom:16px;">
                <button class="card-btn" onclick="switchLeaveTab('use')" id="leaveTabUse">ç”³è¯·è°ƒä¼‘</button>
                <button class="card-btn" onclick="switchLeaveTab('add')" id="leaveTabAdd">è®°å½•åŠ ç­</button>
                <button class="card-btn" onclick="switchLeaveTab('manage')" id="leaveTabManage">è°ƒä¼‘ç®¡ç†</button>
                <button class="card-btn" onclick="switchLeaveTab('history')" id="leaveTabHistory">å†å²è®°å½•</button>
            </div>
            
            <div id="leaveModalContent"></div>
            
            <div class="modal-btns">
                <button class="cancel" onclick="closeLeaveModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <script>
        // æ•°æ®å­˜å‚¨
        let currentUser = null;
        let isAdmin = false;
        let currentMonth = new Date();
        let selectedDate = null;
        let points = 0;
        let leaveDays = 0;
        let leaveHistory = [];
        let currentIdeaTab = 'private';
        let currentLeaveTab = 'use';
        let challengeDraft = { name: '', points: '', date: '', q1: '', q2: '', q3: '', q4: '', q5: '', q6: '' };

        const data = {
            checkins: {},
            dayItems: {},
            weekTasks: [],
            challenges: [],
            ideas: { private: [], company: [] },
            topics: [],
            achievements: {
                monthFull: { current: 0, target: 0, reward: 30, cycle: 'æŒ‰å®é™…ä¸Šç­å¤©æ•°' },
                weekPlan: { current: 0, target: 3, reward: 70 },
                innovation1: { current: 0, target: 10, reward: 100 },
                innovation2: { current: 0, target: 50, reward: 750 },
                innovation3: { current: 0, target: 100, reward: 2000 }
            }
        };

        // ç”¨æˆ·é¢œè‰²æ˜ å°„
        const userColors = ['#fef3c7', '#dbeafe', '#fce7f3', '#d1fae5', '#ede9fe', '#fee2e2'];
        const userColorMap = {};

        const userColorIndexMap = {};
        
        function getUserColorIndex(name) {
            if (userColorIndexMap[name] === undefined) {
                userColorIndexMap[name] = Object.keys(userColorIndexMap).length % 6;
            }
            return userColorIndexMap[name];
        }

        function getUserColor(name) {
            const colors = ['#fef3c7', '#dbeafe', '#fce7f3', '#d1fae5', '#ede9fe', '#fee2e2'];
            return colors[getUserColorIndex(name)];
        }

        function doLogin() {
            const name = document.getElementById('loginName').value.trim();
            if (!name) return alert('è¯·è¾“å…¥å§“å');
            currentUser = name;
            isAdmin = name === 'admin';
            document.getElementById('login').style.display = 'none';
            document.getElementById('app').classList.add('active');
            document.getElementById('userNameDisplay').textContent = name;
            document.getElementById('adminNav').style.display = isAdmin ? 'flex' : 'none';
            initApp();
        }

        function logout() {
            currentUser = null;
            isAdmin = false;
            document.getElementById('login').style.display = 'flex';
            document.getElementById('app').classList.remove('active');
        }

        function getHolidayName(dateStr) {
            const holidays = {
                '2025-01-01': 'å…ƒæ—¦',
                '2025-01-28': 'æ˜¥èŠ‚', '2025-01-29': 'æ˜¥èŠ‚', '2025-01-30': 'æ˜¥èŠ‚', '2025-01-31': 'æ˜¥èŠ‚',
                '2025-02-01': 'æ˜¥èŠ‚', '2025-02-02': 'æ˜¥èŠ‚', '2025-02-03': 'æ˜¥èŠ‚',
                '2025-04-04': 'æ¸…æ˜', '2025-04-05': 'æ¸…æ˜', '2025-04-06': 'æ¸…æ˜',
                '2025-05-01': 'åŠ³åŠ¨', '2025-05-02': 'åŠ³åŠ¨', '2025-05-03': 'åŠ³åŠ¨', '2025-05-04': 'åŠ³åŠ¨', '2025-05-05': 'åŠ³åŠ¨',
                '2025-05-31': 'ç«¯åˆ', '2025-06-01': 'ç«¯åˆ', '2025-06-02': 'ç«¯åˆ',
                '2025-10-01': 'å›½åº†', '2025-10-02': 'å›½åº†', '2025-10-03': 'å›½åº†', '2025-10-04': 'å›½åº†',
                '2025-10-05': 'å›½åº†', '2025-10-06': 'å›½åº†', '2025-10-07': 'å›½åº†', '2025-10-08': 'å›½åº†',
                '2026-01-01': 'å…ƒæ—¦',
                '2026-02-17': 'æ˜¥èŠ‚', '2026-02-18': 'æ˜¥èŠ‚', '2026-02-19': 'æ˜¥èŠ‚', '2026-02-20': 'æ˜¥èŠ‚',
                '2026-02-21': 'æ˜¥èŠ‚', '2026-02-22': 'æ˜¥èŠ‚', '2026-02-23': 'æ˜¥èŠ‚',
                '2026-04-04': 'æ¸…æ˜', '2026-04-05': 'æ¸…æ˜', '2026-04-06': 'æ¸…æ˜',
                '2026-05-01': 'åŠ³åŠ¨', '2026-05-02': 'åŠ³åŠ¨', '2026-05-03': 'åŠ³åŠ¨', '2026-05-04': 'åŠ³åŠ¨', '2026-05-05': 'åŠ³åŠ¨',
                '2026-06-19': 'ç«¯åˆ', '2026-06-20': 'ç«¯åˆ', '2026-06-21': 'ç«¯åˆ',
                '2026-10-01': 'å›½åº†', '2026-10-02': 'å›½åº†', '2026-10-03': 'å›½åº†', '2026-10-04': 'å›½åº†',
                '2026-10-05': 'å›½åº†', '2026-10-06': 'å›½åº†', '2026-10-07': 'å›½åº†', '2026-10-08': 'å›½åº†'
            };
            return holidays[dateStr] || null;
        }

        function getWorkDaysInMonth(year, month) {
            const holidays = getHolidays(year);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            let workDays = 0;
            
            for (let d = 1; d <= daysInMonth; d++) {
                const date = new Date(year, month, d);
                const dayOfWeek = date.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const isHoliday = holidays.includes(dateStr);
                
                if (!isWeekend && !isHoliday) {
                    workDays++;
                }
            }
            return workDays;
        }

        function initApp() {
            // è®¡ç®—å½“æœˆä¸Šç­å¤©æ•°ä½œä¸ºæœˆå…¨å‹¤ç›®æ ‡
            const now = new Date();
            data.achievements.monthFull.target = getWorkDaysInMonth(now.getFullYear(), now.getMonth());
            
            renderCalendar();
            renderCheckin();
            renderWeekTasks();
            renderChallenges();
            renderIdeas();
            renderTopics();
            renderAchievements();
            updatePoints();
        }

        function switchPanel(panel) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`[data-panel="${panel}"]`).classList.add('active');
            document.querySelectorAll('.panel').forEach(el => el.classList.remove('active'));
            document.getElementById(`panel-${panel}`).classList.add('active');
            const titles = { checkin: 'æ‰“å¡ç«™', ideas: 'çµæ„Ÿå¢™', topics: 'é€‰é¢˜æ ', points: 'ç§¯åˆ†ä¸­å¿ƒ', admin: 'ç®¡ç†' };
            document.getElementById('pageTitle').textContent = titles[panel];
        }

        function getHolidays(year) {
            // 2025-2026 ä¸»è¦èŠ‚å‡æ—¥
            const holidays = {
                2025: ['2025-01-01', '2025-01-28', '2025-01-29', '2025-01-30', '2025-01-31', '2025-02-01', '2025-02-02', '2025-02-03', '2025-04-04', '2025-04-05', '2025-04-06', '2025-05-01', '2025-05-02', '2025-05-03', '2025-05-04', '2025-05-05', '2025-05-31', '2025-06-01', '2025-06-02', '2025-10-01', '2025-10-02', '2025-10-03', '2025-10-04', '2025-10-05', '2025-10-06', '2025-10-07', '2025-10-08'],
                2026: ['2026-01-01', '2026-02-17', '2026-02-18', '2026-02-19', '2026-02-20', '2026-02-21', '2026-02-22', '2026-02-23', '2026-04-04', '2026-04-05', '2026-04-06', '2026-05-01', '2026-05-02', '2026-05-03', '2026-05-04', '2026-05-05', '2026-06-19', '2026-06-20', '2026-06-21', '2026-10-01', '2026-10-02', '2026-10-03', '2026-10-04', '2026-10-05', '2026-10-06', '2026-10-07', '2026-10-08']
            };
            return holidays[year] || [];
        }

        // æœˆå†
        function renderCalendar() {
            const y = currentMonth.getFullYear();
            const m = currentMonth.getMonth();
            document.getElementById('calTitle').textContent = `${y}å¹´${m+1}æœˆ`;
            const first = new Date(y, m, 1).getDay();
            const days = new Date(y, m+1, 0).getDate();
            const grid = document.getElementById('calGrid');
            grid.innerHTML = '';
            
            const weekdays = 'ä¸€äºŒä¸‰å››äº”å…­æ—¥'.split('');
            weekdays.forEach((d, idx) => {
                const el = document.createElement('div');
                el.className = 'weekday' + (idx >= 5 ? ' weekend' : '');
                el.textContent = d;
                grid.appendChild(el);
            });
            
            const firstDayOfWeek = first === 0 ? 6 : first - 1;
            for (let i = 0; i < firstDayOfWeek; i++) {
                grid.appendChild(document.createElement('div'));
            }
            
            const today = new Date().toISOString().split('T')[0];
            const holidays = getHolidays(y);
            
            for (let d = 1; d <= days; d++) {
                const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const isToday = ds === today;
                const isPast = ds < today;
                const hasCheckin = data.checkins[ds];
                const items = data.dayItems[ds] || [];
                const dayOfWeek = (firstDayOfWeek + d - 1) % 7;
                const isWeekend = dayOfWeek >= 5;
                const isHoliday = holidays.includes(ds);
                const holidayName = getHolidayName(ds);
                
                const el = document.createElement('div');
                el.className = 'day' + (isToday ? ' today' : '') + (isPast ? ' past' : '') + (isWeekend ? ' weekend' : '') + (isHoliday ? ' holiday' : '');
                el.onclick = () => openDayModal(ds);
                
                let itemsHtml = '';
                items.slice(0, 3).forEach((item, idx) => {
                    const isDone = item.startsWith('âœ“ ');
                    const text = isDone ? item.slice(2) : item;
                    itemsHtml += `
                        <div class="day-item">
                            <div class="day-item-dot"></div>
                            <div class="day-item-text" style="${isDone?'text-decoration:line-through;opacity:0.6':''}">${text}</div>
                            <div class="day-item-check ${isDone?'done':''}" onclick="event.stopPropagation(); toggleDayItem('${ds}', ${idx})">${isDone?'âœ“':''}</div>
                        </div>
                    `;
                });
                
                const moreHtml = items.length > 3 ? `<div class="day-more">+${items.length-3}</div>` : '';
                const checkinHtml = hasCheckin ? '<span class="day-checkin">âœ“</span>' : '';
                const holidayHtml = holidayName ? `<span style="font-size:9px;color:var(--text2);margin-left:2px;">(${holidayName})</span>` : '';
                
                el.innerHTML = `
                    <div class="day-header"><div class="day-num">${d}${holidayHtml}</div>${checkinHtml}</div>
                    <div class="day-content">${itemsHtml}${moreHtml}</div>
                `;
                grid.appendChild(el);
            }
            
            const totalCells = 35;
            const filled = firstDayOfWeek + days;
            for (let i = 0; i < totalCells - filled; i++) {
                grid.appendChild(document.createElement('div'));
            }
        }

        function changeMonth(d) {
            currentMonth.setMonth(currentMonth.getMonth() + d);
            renderCalendar();
        }

        function openDayModal(date) {
            selectedDate = date;
            document.getElementById('dayModalTitle').textContent = date + ' çš„äº‹é¡¹';
            renderDayItems();
            document.getElementById('dayModal').classList.add('active');
        }

        function closeDayModal() {
            document.getElementById('dayModal').classList.remove('active');
            selectedDate = null;
        }

        function renderDayItems() {
            const items = data.dayItems[selectedDate] || [];
            const container = document.getElementById('dayItems');
            if (items.length === 0) {
                container.innerHTML = '<div style="color:var(--text2);padding:20px;text-align:center;font-size:14px;">æš‚æ— äº‹é¡¹</div>';
            } else {
                container.innerHTML = items.map((item, i) => {
                    const isDone = item.startsWith('âœ“ ');
                    const text = isDone ? item.slice(2) : item;
                    return `
                        <div class="modal-item" style="${isDone ? 'opacity:0.6;background:#f0f0f2;' : ''}">
                            <span style="${isDone ? 'text-decoration:line-through;' : ''}">${text}</span>
                            <button onclick="deleteDayItem(${i})" style="${isDone ? 'opacity:0.6;' : ''}">åˆ é™¤</button>
                        </div>
                    `;
                }).join('');
            }
        }

        function addDayItem() {
            const input = document.getElementById('newDayItem');
            const text = input.value.trim();
            if (!text || !selectedDate) return;
            if (!data.dayItems[selectedDate]) data.dayItems[selectedDate] = [];
            data.dayItems[selectedDate].push(text);
            input.value = '';
            renderDayItems();
            renderCalendar();
        }

        function deleteDayItem(idx) {
            if (!selectedDate) return;
            data.dayItems[selectedDate].splice(idx, 1);
            renderDayItems();
            renderCalendar();
        }

        function toggleDayItem(date, idx) {
            if (!data.dayItems[date]) return;
            const item = data.dayItems[date][idx];
            data.dayItems[date][idx] = item.startsWith('âœ“ ') ? item.slice(2) : 'âœ“ ' + item;
            renderCalendar();
        }

        // æ‰“å¡
        // é¼“åŠ±è¯­ï¼ˆ30å¥ï¼‰
        const encouragements = [
            'åˆæ˜¯èµšé’±çš„ä¸€å¤©ï¼',
            'æ—©èµ·æ‰“å¡ï¼Œè´¢å¯Œ+1',
            'ä»Šå¤©çš„ä½ è¶…æ£’ï¼',
            'æ‰“å¡æˆåŠŸï¼Œè¿æ°”çˆ†æ£š',
            'æ–°çš„ä¸€å¤©ï¼Œæ–°çš„æ”¶è·',
            'åšæŒå°±æ˜¯èƒœåˆ©',
            'ä»Šæ—¥ä»½åŠªåŠ›å·²åˆ°è´¦',
            'æ—©èµ·çš„äººå…ˆèµšé’±',
            'æ‰“å¡æ‰“å¡ï¼Œé’±åŒ…é¼“é¼“',
            'åˆæ˜¯å…ƒæ°”æ»¡æ»¡çš„ä¸€å¤©',
            'ä½ çš„åŠªåŠ›å€¼å¾—è¢«çœ‹è§',
            'ä»Šæ—¥æ‰“å¡ï¼Œæ˜æ—¥æš´å¯Œ',
            'åšæŒæ‰“å¡ï¼Œå¥–é‡‘åœ¨æœ›',
            'æ—©èµ·æ‰“å¡ï¼Œé¢†å…ˆä¸€æ­¥',
            'ä»Šå¤©çš„ä½ é—ªé—ªå‘å…‰',
            'æ‰“å¡æˆåŠŸï¼Œç»§ç»­åŠ æ²¹',
            'æ¯ä¸€åˆ†é’±éƒ½å€¼å¾—',
            'ä½ çš„åŠªåŠ›æœ‰å›æŠ¥',
            'æ–°çš„ä¸€å¤©ï¼Œæ–°çš„æœºä¼š',
            'æ‰“å¡å®Œæˆï¼Œå¿ƒæƒ…ç¾ä¸½',
            'æ—©èµ·çš„äººæœ€å¹¸è¿',
            'ä»Šæ—¥ä»½è‡ªå¾‹å·²è¾¾æˆ',
            'ä½ æ­£åœ¨å˜å¾—æ›´å¥½',
            'æ‰“å¡æˆåŠŸï¼Œèƒ½é‡æ»¡æ»¡',
            'ä»Šå¤©çš„ä½ å¾ˆæœ‰é’±é€”',
            'åšæŒæ‰“å¡ï¼Œæœªæ¥å¯æœŸ',
            'æ—©èµ·æ‰“å¡ï¼Œæ•ˆç‡ç¿»å€',
            'ä½ çš„åŠªåŠ›ä¸ä¼šç™½è´¹',
            'åˆæ˜¯æ”¶è·æ»¡æ»¡çš„ä¸€å¤©',
            'æ–°çš„ä¸€å¤©ï¼Œæ–°çš„å¼€å§‹'
        ];

        // é’±ç›¸å…³emoji
        const moneyEmojis = ['ğŸ’°', 'ğŸ’µ', 'ğŸ’¸', 'ğŸª™', 'ğŸ’', 'âœ¨', 'ğŸŒŸ', 'ğŸ”¥', 'ğŸ’ª', 'ğŸ‘', 'ğŸ‰', 'ğŸŠ'];

        function renderCheckin() {
            const today = new Date().toISOString().split('T')[0];
            const box = document.getElementById('checkinBox');
            if (data.checkins[today]) {
                box.innerHTML = '<div class="checkin-done">æ‰“å¡æˆåŠŸ âœ“</div>';
            } else {
                box.innerHTML = '<button class="checkin-btn" onclick="doCheckin()">ç«‹å³æ‰“å¡</button>';
            }
        }

        function doCheckin() {
            const today = new Date().toISOString().split('T')[0];
            
            // å…ˆè·å–æŒ‰é’®ä½ç½®å¹¶æ˜¾ç¤ºåŠ¨ç”»
            const btn = document.querySelector('.checkin-btn');
            if (btn) {
                const rect = btn.getBoundingClientRect();
                showCheckinRewardAt(rect.left + rect.width / 2, rect.top + rect.height / 2);
            }
            
            data.checkins[today] = true;
            points += 2;
            updatePoints();
            renderCheckin();
            updateAchievementProgress('monthFull', Object.keys(data.checkins).length);
        }

        function showCheckinRewardAt(centerX, centerY) {
            // éšæœºé¼“åŠ±è¯­
            const text = encouragements[Math.floor(Math.random() * encouragements.length)];
            
            // æ˜¾ç¤ºé¼“åŠ±è¯­
            const textEl = document.createElement('div');
            textEl.textContent = text;
            textEl.style.cssText = `
                position: fixed;
                left: ${centerX}px;
                top: ${centerY - 50}px;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #ffc107, #ff9800);
                color: white;
                padding: 8px 16px;
                border-radius: 20px;
                font-size: 14px;
                font-weight: 600;
                z-index: 10000;
                pointer-events: none;
                animation: textPop 1.5s ease-out forwards;
            `;
            document.body.appendChild(textEl);
            setTimeout(() => textEl.remove(), 1500);
            
            // æ˜¾ç¤º +2åˆ†
            const pointsEl = document.createElement('div');
            pointsEl.textContent = '+2åˆ†';
            pointsEl.style.cssText = `
                position: fixed;
                left: ${centerX}px;
                top: ${centerY - 20}px;
                transform: translateX(-50%);
                color: var(--success);
                font-size: 28px;
                font-weight: 800;
                z-index: 10001;
                pointer-events: none;
                text-shadow: 0 2px 4px rgba(0,0,0,0.2);
                animation: pointsPop 1.2s ease-out forwards;
            `;
            document.body.appendChild(pointsEl);
            setTimeout(() => pointsEl.remove(), 1200);
            
            // å‘å°„é’±emoji
            for (let i = 0; i < 12; i++) {
                setTimeout(() => {
                    const emoji = moneyEmojis[Math.floor(Math.random() * moneyEmojis.length)];
                    const el = document.createElement('div');
                    el.textContent = emoji;
                    el.style.cssText = `
                        position: fixed;
                        left: ${centerX}px;
                        top: ${centerY}px;
                        font-size: 24px;
                        pointer-events: none;
                        z-index: 9999;
                        transform: translate(-50%, -50%);
                    `;
                    
                    const angle = (Math.PI * 2 * i) / 12 + (Math.random() - 0.5) * 0.5;
                    const distance = 80 + Math.random() * 40;
                    const tx = Math.cos(angle) * distance;
                    const ty = Math.sin(angle) * distance - 50;
                    
                    el.style.setProperty('--tx', tx + 'px');
                    el.style.setProperty('--ty', ty + 'px');
                    el.style.animation = 'emojiPop 1s ease-out forwards';
                    
                    document.body.appendChild(el);
                    setTimeout(() => el.remove(), 1000);
                }, i * 50);
            }
        }

        // è°ƒä¼‘
        function addLeaveDay() {
            leaveDays++;
            document.getElementById('leaveDays').textContent = leaveDays;
            alert('å·²è®°å½•å‘¨å…­æ—¥åŠ ç­ï¼Œè°ƒä¼‘+1å¤©');
        }

        // æœ¬å‘¨è®¡åˆ’
        function openWeekPlanModal() {
            renderWeekPlanTasks();
            document.getElementById('weekPlanModal').classList.add('active');
        }

        function closeWeekPlanModal() {
            document.getElementById('weekPlanModal').classList.remove('active');
        }

        function renderWeekPlanTasks() {
            const container = document.getElementById('weekPlanTasks');
            if (data.weekTasks.length === 0) {
                container.innerHTML = '<div style="color:var(--text2);padding:10px;">æš‚æ— ä»»åŠ¡</div>';
            } else {
                container.innerHTML = data.weekTasks.map((t, i) => `
                    <div class="modal-item"><span>${t.text}</span><button onclick="deleteWeekTask(${i})">åˆ é™¤</button></div>
                `).join('');
            }
        }

        function addWeekPlanTask() {
            const input = document.getElementById('weekPlanInput');
            const text = input.value.trim();
            if (!text) return;
            data.weekTasks.push({ text, status: 'todo' });
            input.value = '';
            renderWeekPlanTasks();
            renderWeekTasks();
        }

        function deleteWeekTask(idx) {
            data.weekTasks.splice(idx, 1);
            renderWeekPlanTasks();
            renderWeekTasks();
        }

        function renderWeekTasks() {
            const list = document.getElementById('taskList');
            if (data.weekTasks.length === 0) {
                list.innerHTML = '<div style="color:var(--text2);font-size:12px;padding:10px 0;">æš‚æ— ä»»åŠ¡ï¼Œç‚¹å‡»å³ä¸Šè§’è®¾ç½®</div>';
            } else {
                list.innerHTML = data.weekTasks.map((t, i) => {
                    const statusClass = t.status;
                    const statusText = t.status === 'todo' ? 'æœªå¼€å§‹' : t.status === 'doing' ? 'è¿›è¡Œä¸­' : 'å·²å®Œæˆ';
                    return `
                        <div class="task-item">
                            <div class="task-text">${t.text}</div>
                            <button class="task-status ${statusClass}" onclick="toggleTaskStatus(${i})">${statusText}</button>
                        </div>
                    `;
                }).join('');
            }
        }

        function toggleTaskStatus(idx) {
            const status = data.weekTasks[idx].status;
            if (status === 'todo') data.weekTasks[idx].status = 'doing';
            else if (status === 'doing') {
                data.weekTasks[idx].status = 'done';
                const btn = event.target;
                const rect = btn.getBoundingClientRect();
                showFireworks(rect.left + rect.width/2, rect.top + rect.height/2);
            }
            else data.weekTasks[idx].status = 'todo';
            renderWeekTasks();
        }

        function showFireworks(x, y) {
            const emojis = ['ğŸ‰', 'âœ¨', 'ğŸŒŸ', 'ğŸ’«', 'ğŸŠ', 'ğŸ”¥', 'ğŸ’ª', 'ğŸ‘'];
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7', '#fd79a8'];
            
            for (let i = 0; i < 4; i++) {
                setTimeout(() => {
                    const el = document.createElement('div');
                    el.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                    el.style.cssText = `position:fixed;left:${x}px;top:${y}px;font-size:24px;pointer-events:none;z-index:9999;transform:translate(-50%,-50%);`;
                    const angle = (Math.PI * 2 * i) / 4 + (Math.random() - 0.5);
                    const dist = 60 + Math.random() * 40;
                    el.style.setProperty('--tx', Math.cos(angle) * dist + 'px');
                    el.style.setProperty('--ty', Math.sin(angle) * dist - 30 + 'px');
                    el.style.animation = 'emojiPop 0.8s ease-out forwards';
                    document.body.appendChild(el);
                    setTimeout(() => el.remove(), 800);
                }, i * 80);
            }
            
            for (let i = 0; i < 15; i++) {
                setTimeout(() => {
                    const el = document.createElement('div');
                    el.style.cssText = `position:fixed;left:${x}px;top:${y}px;width:6px;height:6px;background:${colors[Math.floor(Math.random()*colors.length)]};border-radius:50%;pointer-events:none;z-index:9998;`;
                    const angle = Math.random() * Math.PI * 2;
                    const dist = 40 + Math.random() * 50;
                    el.style.setProperty('--tx', Math.cos(angle) * dist + 'px');
                    el.style.setProperty('--ty', Math.sin(angle) * dist + 'px');
                    el.style.animation = 'particlePop 0.6s ease-out forwards';
                    document.body.appendChild(el);
                    setTimeout(() => el.remove(), 600);
                }, i * 20);
            }
        }

        // æŒ‘æˆ˜ä»»åŠ¡
        function openChallengeModal() {
            document.getElementById('chName').value = challengeDraft.name;
            document.getElementById('chPoints').value = challengeDraft.points;
            document.getElementById('chDate').value = challengeDraft.date;
            document.getElementById('chQ1').value = challengeDraft.q1;
            document.getElementById('chQ2').value = challengeDraft.q2;
            document.getElementById('chQ3').value = challengeDraft.q3;
            document.getElementById('chQ4').value = challengeDraft.q4;
            document.getElementById('chQ5').value = challengeDraft.q5;
            document.getElementById('chQ6').value = challengeDraft.q6;
            document.getElementById('challengeModal').classList.add('active');
        }

        function closeChallengeModal() {
            challengeDraft = {
                name: document.getElementById('chName').value,
                points: document.getElementById('chPoints').value,
                days: document.getElementById('chDays').value,
                q1: document.getElementById('chQ1').value,
                q2: document.getElementById('chQ2').value,
                q3: document.getElementById('chQ3').value,
                q4: document.getElementById('chQ4').value,
                q5: document.getElementById('chQ5').value,
                q6: document.getElementById('chQ6').value
            };
            document.getElementById('challengeModal').classList.remove('active');
        }

        function openChallengeModal() {
            document.getElementById('challengeModal').classList.add('active');
            if (challengeDraft.name) {
                document.getElementById('chName').value = challengeDraft.name;
                document.getElementById('chPoints').value = challengeDraft.points;
                document.getElementById('chDays').value = challengeDraft.days || '';
                document.getElementById('chQ1').value = challengeDraft.q1;
                document.getElementById('chQ2').value = challengeDraft.q2;
                document.getElementById('chQ3').value = challengeDraft.q3;
                document.getElementById('chQ4').value = challengeDraft.q4;
                document.getElementById('chQ5').value = challengeDraft.q5;
                document.getElementById('chQ6').value = challengeDraft.q6;
            }
        }

        function submitChallenge() {
            const name = document.getElementById('chName').value.trim();
            const pointsVal = document.getElementById('chPoints').value;
            const days = document.getElementById('chDays').value;
            if (!name || !pointsVal || !days) return alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
            
            // è®¡ç®—æˆªæ­¢æ—¥æœŸ
            const deadline = new Date();
            deadline.setDate(deadline.getDate() + parseInt(days));
            const dateStr = `${deadline.getMonth()+1}/${deadline.getDate()}`;
            
            data.challenges.push({ id: Date.now(), name, points: parseInt(pointsVal), days: parseInt(days), deadline: dateStr, status: 'pending' });
            challengeDraft = { name: '', points: '', days: '', q1: '', q2: '', q3: '', q4: '', q5: '', q6: '' };
            ['chName', 'chPoints', 'chDays', 'chQ1', 'chQ2', 'chQ3', 'chQ4', 'chQ5', 'chQ6'].forEach(id => document.getElementById(id).value = '');
            closeChallengeModal();
            renderChallenges();
            alert('ç”³æŠ¥å·²æäº¤');
        }

        function renderChallenges() {
            const list = document.getElementById('challengeList');
            if (data.challenges.length === 0) {
                list.innerHTML = '<div style="color:var(--text2);font-size:12px;padding:10px 0;">æš‚æ— æŒ‘æˆ˜ä»»åŠ¡</div>';
            } else {
                list.innerHTML = data.challenges.map(c => {
                    const statusClass = c.status;
                    const statusText = c.status === 'pending' ? 'ç”³æŠ¥ä¸­' : c.status === 'doing' ? 'è¿›è¡Œä¸­' : 'å·²å®Œæˆ';
                    return `
                        <div class="challenge-item">
                            <div class="challenge-info"><div class="challenge-name">${c.name}</div><div class="challenge-meta">${c.deadline}æˆªæ­¢</div></div>
                            <div class="challenge-points">${c.points}åˆ†</div>
                            <div class="challenge-status ${statusClass}">${statusText}</div>
                        </div>
                    `;
                }).join('');
            }
        }

        // çµæ„Ÿå¢™
        function switchIdeaTab(tab) {
            currentIdeaTab = tab;
            document.querySelectorAll('.ideas-tab').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
            renderIdeas();
        }

        function renderIdeas() {
            const grid = document.getElementById('ideasGrid');
            const ideas = data.ideas[currentIdeaTab] || [];
            
            if (ideas.length === 0) {
                grid.innerHTML = '<div style="color:var(--text2);padding:40px;">è¿˜æ²¡æœ‰ä¾¿åˆ©è´´</div>';
                return;
            }
            
            grid.innerHTML = ideas.slice().reverse().map((idea, idx) => {
                const isStarred = idea.starred;
                // ä½¿ç”¨ä¿å­˜çš„é¢œè‰²ç´¢å¼•ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ ¹æ®ä½œè€…åˆ†é…
                if (idea.colorIndex === undefined) {
                    idea.colorIndex = getUserColorIndex(idea.author);
                }
                const colorIndex = idea.colorIndex;
                
                return `
                    <div class="idea-note ${isStarred?'starred':''}" data-color="${colorIndex}">
                        <div class="idea-author">
                            <span>${currentIdeaTab==='company'?idea.author:'æˆ‘'}</span>
                            <span class="idea-time">${idea.time}</span>
                        </div>
                        <div class="idea-content">${idea.content}</div>
                        <div class="idea-actions">
                            <button class="idea-btn star ${isStarred?'active':''}" onclick="toggleStar(${ideas.length-1-idx})">â­</button>
                            <button class="idea-btn delete" onclick="deleteIdea(${ideas.length-1-idx})">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function addIdea() {
            const content = document.getElementById('ideaInput').value.trim();
            if (!content) return;
            
            const now = new Date();
            const time = `${now.getMonth()+1}/${now.getDate()} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            
            // ç¡®ä¿é¢œè‰²ç´¢å¼•è¢«æ­£ç¡®è®¾ç½®
            const colorIdx = getUserColorIndex(currentUser);
            console.log('Adding idea with color index:', colorIdx, 'for user:', currentUser);
            
            data.ideas[currentIdeaTab].push({
                content,
                author: currentUser,
                time,
                starred: false,
                colorIndex: colorIdx
            });
            
            document.getElementById('ideaInput').value = '';
            renderIdeas();
        }

        function toggleStar(idx) {
            data.ideas[currentIdeaTab][idx].starred = !data.ideas[currentIdeaTab][idx].starred;
            renderIdeas();
        }

        function deleteIdea(idx) {
            data.ideas[currentIdeaTab].splice(idx, 1);
            renderIdeas();
        }

        // é€‰é¢˜æ 
        function openTopicModal() {
            document.getElementById('topicModal').classList.add('active');
        }

        function closeTopicModal() {
            document.getElementById('topicModal').classList.remove('active');
        }

        function previewTopicImage(input) {
            if (input.files && input.files[0]) {
                // é¢„è§ˆé€»è¾‘
            }
        }

        function submitTopic() {
            const title = document.getElementById('topicTitle').value.trim();
            const desc = document.getElementById('topicDesc').value.trim();
            if (!title || !desc) return alert('è¯·å¡«å†™æ ‡é¢˜å’Œå†…å®¹');
            
            data.topics.push({
                id: Date.now(),
                title,
                desc,
                author: currentUser,
                points: 5,
                status: 'pending'
            });
            
            points += 5;
            updatePoints();
            
            document.getElementById('topicTitle').value = '';
            document.getElementById('topicDesc').value = '';
            closeTopicModal();
            renderTopics();
            alert('é€‰é¢˜å·²æäº¤ï¼Œ+5ç§¯åˆ†');
        }

        function renderTopics() {
            const list = document.getElementById('topicList');
            if (data.topics.length === 0) {
                list.innerHTML = '<div style="color:var(--text2);text-align:center;padding:40px;">æš‚æ— é€‰é¢˜</div>';
            } else {
                list.innerHTML = data.topics.slice().reverse().map(t => `
                    <div class="topic-card">
                        <div class="topic-image">ğŸ“·</div>
                        <div class="topic-content">
                            <div class="topic-title">${t.title}</div>
                            <div class="topic-desc">${t.desc}</div>
                            <div class="topic-meta">
                                <span class="topic-author">${t.author}</span>
                                <span class="topic-points">+${t.points}åˆ†</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        // ç§¯åˆ†ä¸­å¿ƒ
        function renderAchievements() {
            // æ›´æ–°æœˆå…¨å‹¤ç›®æ ‡ï¼ˆåŠ¨æ€è®¡ç®—å½“æœˆä¸Šç­å¤©æ•°ï¼‰
            const now = new Date();
            data.achievements.monthFull.target = getWorkDaysInMonth(now.getFullYear(), now.getMonth());
            
            // æœˆå…¨å‹¤è¿›åº¦
            const monthFullPct = (data.achievements.monthFull.current / data.achievements.monthFull.target) * 100;
            document.getElementById('monthFullProgress').style.width = monthFullPct + '%';
            document.getElementById('monthFullProgress').className = 'steam-progress-bar ' + (monthFullPct === 100 ? 'green' : monthFullPct > 50 ? 'yellow' : 'gray');
            document.getElementById('monthFullText').textContent = `${data.achievements.monthFull.current}/${data.achievements.monthFull.target}å¤©`;
            
            // å‘¨è®¡åˆ’è¿›åº¦
            const weekPlanPct = (data.achievements.weekPlan.current / data.achievements.weekPlan.target) * 100;
            document.getElementById('weekPlanProgress').style.width = weekPlanPct + '%';
            document.getElementById('weekPlanProgress').className = 'steam-progress-bar ' + (weekPlanPct === 100 ? 'green' : weekPlanPct > 50 ? 'yellow' : 'gray');
            document.getElementById('weekPlanText').textContent = `${data.achievements.weekPlan.current}/${data.achievements.weekPlan.target}å‘¨`;
            
            // åˆ›æ–°ä»»åŠ¡è¿›åº¦
            const innov1Pct = (data.achievements.innovation1.current / data.achievements.innovation1.target) * 100;
            document.getElementById('innovationProgress1').style.width = innov1Pct + '%';
            document.getElementById('innovationProgress1').className = 'steam-progress-bar ' + (innov1Pct === 100 ? 'green' : innov1Pct > 50 ? 'yellow' : 'gray');
            document.getElementById('innovationText1').textContent = `${data.achievements.innovation1.current}/${data.achievements.innovation1.target}ä¸ªæŒ‘æˆ˜`;
            
            const innov2Pct = (data.achievements.innovation2.current / data.achievements.innovation2.target) * 100;
            document.getElementById('innovationProgress2').style.width = innov2Pct + '%';
            document.getElementById('innovationProgress2').className = 'steam-progress-bar ' + (innov2Pct === 100 ? 'green' : innov2Pct > 30 ? 'yellow' : 'gray');
            document.getElementById('innovationText2').textContent = `${data.achievements.innovation2.current}/${data.achievements.innovation2.target}ä¸ªæŒ‘æˆ˜`;
            
            const innov3Pct = (data.achievements.innovation3.current / data.achievements.innovation3.target) * 100;
            document.getElementById('innovationProgress3').style.width = innov3Pct + '%';
            document.getElementById('innovationProgress3').className = 'steam-progress-bar ' + (innov3Pct === 100 ? 'green' : innov3Pct > 20 ? 'yellow' : 'gray');
            document.getElementById('innovationText3').textContent = `${data.achievements.innovation3.current}/${data.achievements.innovation3.target}ä¸ªæŒ‘æˆ˜`;
        }

        function updateAchievementProgress(key, value) {
            if (data.achievements[key]) {
                data.achievements[key].current = value;
                renderAchievements();
            }
        }

        function exchangeItem(type, cost) {
            if (points < cost) return alert('ç§¯åˆ†ä¸è¶³');
            if (type === 'leave') {
                leaveDays++;
                document.getElementById('leaveDays').textContent = leaveDays;
            }
            points -= cost;
            updatePoints();
            alert('å…‘æ¢æˆåŠŸï¼');
        }

        function updatePoints() {
            document.getElementById('userPoints').textContent = 'ğŸ’° ' + points;
        }

        // è¡¥å¡åŠŸèƒ½
        function openMakeupModal() {
            document.getElementById('makeupModal').classList.add('active');
        }

        function closeMakeupModal() {
            document.getElementById('makeupModal').classList.remove('active');
        }

        function submitMakeup() {
            const date = document.getElementById('makeupDate').value;
            const reason = document.getElementById('makeupReason').value.trim();
            if (!date || !reason) return alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
            alert('è¡¥å¡ç”³è¯·å·²æäº¤');
            closeMakeupModal();
        }

        // è°ƒä¼‘åŠŸèƒ½
        function openLeaveModal() {
            renderLeaveModalContent();
            document.getElementById('leaveModal').classList.add('active');
        }

        function closeLeaveModal() {
            document.getElementById('leaveModal').classList.remove('active');
        }

        function switchLeaveTab(tab) {
            currentLeaveTab = tab;
            document.querySelectorAll('#leaveModal .card-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('leaveTab' + tab.charAt(0).toUpperCase() + tab.slice(1))?.classList.add('active');
            renderLeaveModalContent();
        }

        function renderLeaveModalContent() {
            const container = document.getElementById('leaveModalContent');
            if (!container) return;
            
            if (currentLeaveTab === 'use') {
                container.innerHTML = `
                    <div class="modal-row">
                        <input type="date" id="leaveUseDate" placeholder="è°ƒä¼‘æ—¥æœŸ">
                    </div>
                    <div class="modal-row">
                        <select id="leaveUseType" style="flex:1;padding:12px;border:1px solid var(--border);border-radius:10px;font-size:14px;">
                            <option value="half">åŠå¤©ï¼ˆå‘¨ä¸‰-å‘¨äº”ï¼‰</option>
                            <option value="full">å…¨å¤©</option>
                        </select>
                    </div>
                    <button class="card-btn" onclick="submitLeaveUse()" style="width:100%;padding:12px;margin-top:8px;">æäº¤ç”³è¯·</button>
                `;
            } else if (currentLeaveTab === 'add') {
                container.innerHTML = `
                    <div class="modal-row">
                        <input type="date" id="leaveAddDate" placeholder="åŠ ç­æ—¥æœŸ">
                    </div>
                    <div class="modal-row">
                        <select id="leaveAddType" style="flex:1;padding:12px;border:1px solid var(--border);border-radius:10px;font-size:14px;">
                            <option value="weekend">å‘¨å…­æ—¥åŠ ç­ï¼ˆ+1å¤©ï¼‰</option>
                            <option value="holiday">èŠ‚å‡æ—¥åŠ ç­ï¼ˆ+1å¤©ï¼‰</option>
                        </select>
                    </div>
                    <button class="card-btn" onclick="submitLeaveAdd()" style="width:100%;padding:12px;margin-top:8px;background:var(--success);color:white;">è®°å½•åŠ ç­</button>
                `;
            } else if (currentLeaveTab === 'manage') {
                container.innerHTML = `
                    <div style="padding:16px;background:var(--bg);border-radius:12px;margin-bottom:16px;">
                        <div style="font-size:14px;color:var(--text2);margin-bottom:8px;">å½“å‰è°ƒä¼‘å¤©æ•°</div>
                        <div style="font-size:32px;font-weight:700;color:var(--accent);"><span id="manageLeaveDays">${leaveDays}</span><span style="font-size:14px;font-weight:400;color:var(--text2);margin-left:4px;">å¤©</span></div>
                    </div>
                    <div class="modal-row">
                        <select id="manageType" style="flex:1;padding:12px;border:1px solid var(--border);border-radius:10px;font-size:14px;">
                            <option value="add">å¢åŠ è°ƒä¼‘</option>
                            <option value="subtract">å‡å°‘è°ƒä¼‘</option>
                        </select>
                        <input type="number" id="manageDays" placeholder="å¤©æ•°" min="0.5" step="0.5" style="flex:1;">
                    </div>
                    <div class="modal-row">
                        <input type="text" id="manageReason" placeholder="å¤‡æ³¨è¯´æ˜ï¼ˆå¦‚ï¼šå­£åº¦ç»“ç®—ã€åŠ ç­è¡¥å¿ç­‰ï¼‰" style="flex:1;">
                    </div>
                    <button class="card-btn" onclick="submitManage()" style="width:100%;padding:12px;margin-top:8px;background:var(--accent);color:white;">ç¡®è®¤è°ƒæ•´</button>
                `;
            } else {
                container.innerHTML = `
                    <div class="leave-history">
                        ${leaveHistory.length === 0 ? '<div style="color:var(--text2);text-align:center;padding:20px;">æš‚æ— è®°å½•</div>' : 
                            leaveHistory.slice().reverse().map(h => `
                                <div class="leave-history-item">
                                    <span>${h.date} ${h.desc}</span>
                                    <span style="display:flex;align-items:center;gap:8px;"><span style="font-size:11px;color:var(--text2);font-family:monospace;">${h.beforeDays}â†’${h.afterDays}</span><span style="padding:2px 8px;border-radius:10px;font-size:11px;font-weight:500;${h.type==='add'?'background:rgba(52,199,89,0.15);color:var(--success);':h.type==='use'?'background:rgba(255,59,48,0.15);color:var(--danger);':h.type==='manage'&&h.afterDays>h.beforeDays?'background:rgba(52,199,89,0.15);color:var(--success);':h.type==='manage'&&h.afterDays<h.beforeDays?'background:rgba(255,59,48,0.15);color:var(--danger);':'background:var(--bg);color:var(--text2);'}">${h.type==='add'?'è·å¾—è°ƒä¼‘':h.type==='use'?'ä½¿ç”¨è°ƒä¼‘':h.type==='manage'&&h.afterDays>h.beforeDays?'å¢åŠ å¤©æ•°':h.type==='manage'&&h.afterDays<h.beforeDays?'å‡å°‘å¤©æ•°':h.type==='reset'?'å­£åº¦ç»“ç®—':'è°ƒæ•´'}</span></span>
                                </div>
                            `).join('')}
                    </div>
                `;
            }
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return `${date.getMonth() + 1}/${date.getDate()}`;
        }

        function submitLeaveUse() {
            const date = document.getElementById('leaveUseDate')?.value;
            const type = document.getElementById('leaveUseType')?.value;
            if (!date) return alert('è¯·é€‰æ‹©æ—¥æœŸ');
            const days = type === 'half' ? 0.5 : 1;
            if (leaveDays < days) return alert('è°ƒä¼‘å¤©æ•°ä¸è¶³');
            const beforeDays = leaveDays;
            leaveDays -= days;
            leaveHistory.push({ date: formatDate(date), type: 'use', days, desc: type === 'half' ? 'è°ƒä¼‘åŠå¤©' : 'è°ƒä¼‘å…¨å¤©', beforeDays, afterDays: leaveDays });
            updateLeaveDisplay();
            renderLeaveModalContent();
            alert('è°ƒä¼‘ç”³è¯·å·²è®°å½•');
        }

        function submitLeaveAdd() {
            const date = document.getElementById('leaveAddDate')?.value;
            if (!date) return alert('è¯·é€‰æ‹©æ—¥æœŸ');
            const beforeDays = leaveDays;
            leaveDays += 1;
            leaveHistory.push({ date: formatDate(date), type: 'add', days: 1, desc: 'åŠ ç­è®°å½•', beforeDays, afterDays: leaveDays });
            updateLeaveDisplay();
            renderLeaveModalContent();
            alert('åŠ ç­è®°å½•å·²æ·»åŠ ï¼Œè°ƒä¼‘+1å¤©');
        }

        function submitManage() {
            const type = document.getElementById('manageType')?.value;
            const days = parseFloat(document.getElementById('manageDays')?.value);
            const reason = document.getElementById('manageReason')?.value.trim() || 'æ‰‹åŠ¨è°ƒæ•´';
            
            if (!days || days <= 0) return alert('è¯·è¾“å…¥å¤©æ•°');
            
            const beforeDays = leaveDays;
            
            if (type === 'subtract') {
                if (days > leaveDays) return alert('å‡å°‘å¤©æ•°ä¸èƒ½è¶…è¿‡å½“å‰è°ƒä¼‘å¤©æ•°');
                leaveDays -= days;
                leaveHistory.push({ 
                    date: formatDate(new Date()), 
                    type: 'manage', 
                    days: days, 
                    desc: reason,
                    beforeDays,
                    afterDays: leaveDays
                });
            } else {
                leaveDays += days;
                leaveHistory.push({ 
                    date: formatDate(new Date()), 
                    type: 'manage', 
                    days: days, 
                    desc: reason,
                    beforeDays,
                    afterDays: leaveDays
                });
            }
            
            updateLeaveDisplay();
            renderLeaveModalContent();
            alert('è°ƒä¼‘å¤©æ•°å·²è°ƒæ•´');
        }

        function updateLeaveDisplay() {
            document.getElementById('leaveDays').textContent = leaveDays;
        }

        // å­£åº¦æ¸…ç©ºæ£€æŸ¥
        function checkQuarterReset() {
            const now = new Date();
            const month = now.getMonth();
            const day = now.getDate();
            if (day === 1 && [0, 3, 6, 9].includes(month)) {
                const beforeDays = leaveDays;
                leaveDays = 0;
                leaveHistory.push({ date: formatDate(new Date()), type: 'reset', desc: 'å­£åº¦æ¸…ç©º', beforeDays, afterDays: 0 });
                alert('è°ƒä¼‘å¤©æ•°å·²å­£åº¦æ¸…ç©º');
            }
        }
    </script>
</body>
</html>
